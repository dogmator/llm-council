# 🏛️ LLM Council — Повний Технічний Посібник

> **Мова:** 🇺🇦 Українська  
> **Версія:** 1.0  
> **Остання редакція:** Грудень 2024

---

## 📑 Зміст

1. [🎯 Огляд системи](#-огляд-системи)
2. [🏗️ Архітектура](#️-архітектура)
3. [🔄 Трьохетапна логіка роботи](#-трьохетапна-логіка-роботи)
4. [⚙️ Конфігурація моделей](#️-конфігурація-моделей)
5. [➕ Додавання нових моделей](#-додавання-нових-моделей)
6. [🔌 Інтеграція з OpenRouter API](#-інтеграція-з-openrouter-api)
7. [📊 Система рейтингування](#-система-рейтингування)
8. [💾 Зберігання даних](#-зберігання-даних)
9. [🚀 Поради та рекомендації](#-поради-та-рекомендації)

---

## 🎯 Огляд системи

**LLM Council** — це інноваційна система колективного прийняття рішень, де декілька великих мовних моделей (LLM) спільно відповідають на запити користувача.

```
╔══════════════════════════════════════════════════════════════════════════╗
║                        🏛️  LLM COUNCIL                                   ║
║                                                                          ║
║   "Мудрість багатьох перевищує мудрість одного"                          ║
║                                                                          ║
║   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                     ║
║   │  GPT    │  │ Gemini  │  │ Claude  │  │  Grok   │                     ║
║   │  5.1    │  │  3 Pro  │  │ Sonnet  │  │   4     │                     ║
║   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                     ║
║        │            │            │            │                          ║
║        └────────────┴─────┬──────┴────────────┘                          ║
║                           ▼                                              ║
║                   ┌──────────────┐                                       ║
║                   │  🎖️ ГОЛОВА   │                                       ║
║                   │   (Chairman) │                                       ║
║                   └──────────────┘                                       ║
╚══════════════════════════════════════════════════════════════════════════╝
```

### 🌟 Ключові особливості

| Особливість | Опис |
|-------------|------|
| 🤝 **Колективний інтелект** | Декілька моделей працюють разом |
| 🎭 **Анонімне оцінювання** | Моделі не знають, чию відповідь оцінюють |
| 📊 **Агреговані рейтинги** | Автоматичний підрахунок найкращих відповідей |
| 🏆 **Синтез від Chairman** | Голова ради формує фінальну відповідь |
| ⚡ **Паралельні запити** | Швидкість завдяки async/await |

---

## 🏗️ Архітектура

### 📁 Структура проєкту

```
llm-council/
├── 📂 backend/
│   ├── 🐍 __init__.py          # Ініціалізація модуля
│   ├── ⚙️ config.py            # Конфігурація моделей та API
│   ├── 🧠 council.py           # Головна логіка 3-х етапів
│   ├── 🌐 openrouter.py        # API клієнт OpenRouter
│   ├── 💾 storage.py           # Зберігання розмов (JSON)
│   └── 🚀 main.py              # FastAPI сервер
├── 📂 frontend/
│   └── 📂 src/
│       ├── 🎨 App.jsx          # Головний компонент
│       ├── 📡 api.js           # API клієнт
│       └── 📂 components/
│           ├── Stage1.jsx      # Відображення етапу 1
│           ├── Stage2.jsx      # Відображення етапу 2
│           └── Stage3.jsx      # Відображення етапу 3
├── 📂 data/conversations/       # Збережені розмови
└── 📄 .env                      # API ключ (секретно!)
```

### 🔗 Взаємодія компонентів

```
┌─────────────────────────────────────────────────────────────────────┐
│                          🖥️ FRONTEND (React + Vite)                 │
│                              localhost:5173                         │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/REST API
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          🐍 BACKEND (FastAPI)                       │
│                              localhost:8001                         │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │   main.py    │──│  council.py  │──│ openrouter.py│              │
│  │  (API Routes)│  │   (Logic)    │  │ (API Client) │              │
│  └──────────────┘  └──────────────┘  └──────┬───────┘              │
│                                             │                       │
│  ┌──────────────┐  ┌──────────────┐         │                       │
│  │  storage.py  │  │  config.py   │         │                       │
│  │   (JSON DB)  │  │  (Settings)  │         │                       │
│  └──────────────┘  └──────────────┘         │                       │
└─────────────────────────────────────────────┼───────────────────────┘
                                              │
                                              │ HTTPS API calls
                                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     ☁️ OPENROUTER API                                │
│                 https://openrouter.ai/api/v1                        │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │ OpenAI  │  │ Google  │  │Anthropic│  │   xAI   │  │  інші   │  │
│  │  GPT    │  │ Gemini  │  │ Claude  │  │  Grok   │  │ 100+... │  │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Трьохетапна логіка роботи

### 📊 Загальна схема потоку даних

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                        💬 ЗАПИТ КОРИСТУВАЧА                               ║
║                     "Яка столиця України?"                                ║
╚═══════════════════════════════════════════════════════════════════════════╝
                                    │
                                    ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                        📍 ЕТАП 1: ЗБІР ВІДПОВІДЕЙ                        │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
    │    🤖 GPT     │       │   🤖 Gemini   │       │   🤖 Claude   │
    │   Відповідь A │       │   Відповідь B │       │   Відповідь C │
    └───────────────┘       └───────────────┘       └───────────────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    │
                                    ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                      🎭 ЕТАП 2: АНОНІМНЕ ОЦІНЮВАННЯ                   │
│                                                                       │
│   Всі відповіді анонімізуються: "Response A", "Response B", etc.      │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
    │    🤖 GPT     │       │   🤖 Gemini   │       │   🤖 Claude   │
    │   Рейтинг:    │       │   Рейтинг:    │       │   Рейтинг:    │
    │   1. Resp C   │       │   1. Resp A   │       │   1. Resp B   │
    │   2. Resp A   │       │   2. Resp C   │       │   2. Resp A   │
    │   3. Resp B   │       │   3. Resp B   │       │   3. Resp C   │
    └───────────────┘       └───────────────┘       └───────────────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    │
                                    ▼
        ┌───────────────────────────────────────────────────────┐
        │              📊 АГРЕГОВАНІ РЕЙТИНГИ                   │
        │                                                       │
        │   Модель         │ Середня позиція │ Кількість голосів│
        │   ─────────────────────────────────────────────────── │
        │   🥇 Claude       │      1.67       │        3        │
        │   🥈 GPT          │      2.00       │        3        │
        │   🥉 Gemini       │      2.33       │        3        │
        └───────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                         🎖️ ЕТАП 3: СИНТЕЗ                             │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │     🎖️ CHAIRMAN       │
                        │      (Gemini 3)       │
                        │                       │
                        │  Отримує:             │
                        │  • Всі відповіді      │
                        │  • Всі оцінки         │
                        │  • Агреговані рейтинги│
                        │                       │
                        │  Генерує:             │
                        │  📝 ФІНАЛЬНУ ВІДПОВІДЬ│
                        └───────────────────────┘
                                    │
                                    ▼
╔══════════════════════════════════════════════════════════════════════════╗
║                         ✅ ФІНАЛЬНА ВІДПОВІДЬ                            ║
║                                                                          ║
║   "Столиця України — місто Київ. Це найбільше місто країни з             ║
║   населенням понад 3 мільйони жителів..."                                ║
╚══════════════════════════════════════════════════════════════════════════╝
```

### 📍 Етап 1: Збір відповідей (`stage1_collect_responses`)

```python
# 📁 backend/council.py

async def stage1_collect_responses(user_query: str) -> List[Dict[str, Any]]:
    """
    Паралельно відправляє запит всім моделям ради
    та збирає їхні індивідуальні відповіді.
    """
    messages = [{"role": "user", "content": user_query}]
    
    # 🚀 Паралельні запити до всіх моделей
    responses = await query_models_parallel(COUNCIL_MODELS, messages)
    
    # ✅ Фільтрація успішних відповідей
    stage1_results = []
    for model, response in responses.items():
        if response is not None:  # Пропускаємо невдалі запити
            stage1_results.append({
                "model": model,
                "response": response.get('content', '')
            })
    
    return stage1_results
```

**🔑 Ключові моменти:**
- Використовується `asyncio.gather()` для паралельних запитів
- Система продовжує працювати навіть якщо деякі моделі не відповіли
- Timeout для кожної моделі: **120 секунд**

### 🎭 Етап 2: Анонімне оцінювання (`stage2_collect_rankings`)

```python
# Анонімізація: створюємо мітки "Response A", "Response B", etc.
labels = [chr(65 + i) for i in range(len(stage1_results))]  # A, B, C, ...

# Мапування для де-анонімізації на frontend
label_to_model = {
    f"Response {label}": result['model']
    for label, result in zip(labels, stage1_results)
}
```

**📋 Формат промпта для оцінювання:**

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  📝 ПРОМПТ ДЛЯ ЕТАПУ 2 (ranking_prompt)                                   ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  You are evaluating different responses to the following question:        ║
║                                                                           ║
║  Question: {user_query}                                                   ║
║                                                                           ║
║  Here are the responses from different models (anonymized):               ║
║                                                                           ║
║  Response A:                                                              ║
║  {відповідь моделі 1}                                                     ║
║                                                                           ║
║  Response B:                                                              ║
║  {відповідь моделі 2}                                                     ║
║                                                                           ║
║  Your task:                                                               ║
║  1. Evaluate each response individually                                   ║
║  2. Provide final ranking at the END                                      ║
║                                                                           ║
║  IMPORTANT: Format MUST be:                                               ║
║                                                                           ║
║  FINAL RANKING:                                                           ║
║  1. Response X                                                            ║
║  2. Response Y                                                            ║
║  3. Response Z                                                            ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**🔍 Парсинг рейтингу:**

```python
def parse_ranking_from_text(ranking_text: str) -> List[str]:
    """
    Витягує розділ "FINAL RANKING:" з відповіді моделі.
    
    Приклад входу:
        "Response A has good detail...
         FINAL RANKING:
         1. Response C
         2. Response A
         3. Response B"
    
    Приклад виходу:
        ["Response C", "Response A", "Response B"]
    """
```

### 🎖️ Етап 3: Синтез фінальної відповіді (`stage3_synthesize_final`)

**Chairman отримує повний контекст:**

| Дані | Опис |
|------|------|
| 📝 Оригінальне питання | Запит користувача |
| 📊 Stage 1 відповіді | Всі індивідуальні відповіді з іменами моделей |
| 🎭 Stage 2 оцінки | Всі рейтинги від кожної моделі |

---

## ⚙️ Конфігурація моделей

### 📁 Файл конфігурації: `backend/config.py`

```python
"""Configuration for the LLM Council."""

import os
from dotenv import load_dotenv

load_dotenv()

# 🔐 API ключ OpenRouter (з .env файлу)
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")

# 👥 Члени ради — список ідентифікаторів моделей OpenRouter
COUNCIL_MODELS = [
    "openai/gpt-5.1",               # 🟢 OpenAI GPT 5.1
    "google/gemini-3-pro-preview",  # 🔵 Google Gemini 3 Pro
    "anthropic/claude-sonnet-4.5",  # 🟣 Anthropic Claude Sonnet 4.5
    "x-ai/grok-4",                  # ⚫ xAI Grok 4
]

# 🎖️ Модель-голова — синтезує фінальну відповідь
CHAIRMAN_MODEL = "google/gemini-3-pro-preview"

# 🌐 Endpoint OpenRouter API
OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"

# 💾 Директорія для зберігання розмов
DATA_DIR = "data/conversations"
```

### 📊 Таблиця поточних моделей

| Змінна | Модель | Провайдер | Роль |
|--------|--------|-----------|------|
| `COUNCIL_MODELS[0]` | gpt-5.1 | OpenAI | 👤 Член ради |
| `COUNCIL_MODELS[1]` | gemini-3-pro-preview | Google | 👤 Член ради + 🎖️ Chairman |
| `COUNCIL_MODELS[2]` | claude-sonnet-4.5 | Anthropic | 👤 Член ради |
| `COUNCIL_MODELS[3]` | grok-4 | xAI | 👤 Член ради |

---

## ➕ Додавання нових моделей

### 📋 Покрокова інструкція

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    🛠️ ПРОЦЕС ДОДАВАННЯ НОВОЇ МОДЕЛІ                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───┐                                                                  │
│  │ 1 │ ▶ Перевірте доступність моделі на OpenRouter                    │
│  └─┬─┘   https://openrouter.ai/models                                  │
│    │                                                                    │
│    ▼                                                                    │
│  ┌───┐                                                                  │
│  │ 2 │ ▶ Скопіюйте ідентифікатор моделі                                │
│  └─┬─┘   Формат: "провайдер/назва-моделі"                              │
│    │     Приклад: "meta-llama/llama-3.1-70b-instruct"                  │
│    │                                                                    │
│    ▼                                                                    │
│  ┌───┐                                                                  │
│  │ 3 │ ▶ Перевірте баланс кредитів OpenRouter                          │
│  └─┬─┘   Переконайтесь, що є достатньо коштів                          │
│    │                                                                    │
│    ▼                                                                    │
│  ┌───┐                                                                  │
│  │ 4 │ ▶ Відредагуйте backend/config.py                                │
│  └─┬─┘   Додайте модель до COUNCIL_MODELS                              │
│    │                                                                    │
│    ▼                                                                    │
│  ┌───┐                                                                  │
│  │ 5 │ ▶ Перезапустіть backend сервер                                  │
│  └─┬─┘   uv run python -m backend.main                                 │
│    │                                                                    │
│    ▼                                                                    │
│  ┌───┐                                                                  │
│  │ 6 │ ▶ Протестуйте нову конфігурацію                                 │
│  └───┘   Надішліть тестовий запит через UI                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 📝 Приклад: Додавання Meta Llama 3.1

**До змін:**
```python
COUNCIL_MODELS = [
    "openai/gpt-5.1",
    "google/gemini-3-pro-preview",
    "anthropic/claude-sonnet-4.5",
    "x-ai/grok-4",
]
```

**Після змін:**
```python
COUNCIL_MODELS = [
    "openai/gpt-5.1",
    "google/gemini-3-pro-preview",
    "anthropic/claude-sonnet-4.5",
    "x-ai/grok-4",
    "meta-llama/llama-3.1-70b-instruct",  # ✅ Нова модель додана!
]
```

### ⚠️ Умови та обмеження для додавання моделей

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                    ⚠️ ОБОВ'ЯЗКОВІ УМОВИ                                   ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  ✅ Модель повинна бути доступна через OpenRouter API                    ║
║                                                                           ║
║  ✅ Ідентифікатор моделі у форматі "провайдер/назва-моделі"              ║
║                                                                           ║
║  ✅ Модель повинна підтримувати Chat Completions API                     ║
║     (стандартний формат messages: [{role, content}])                     ║
║                                                                           ║
║  ✅ Достатній баланс кредитів на OpenRouter                              ║
║                                                                           ║
║  ✅ Модель повинна вміти генерувати структурований вихід                 ║
║     для парсингу рейтингу (FINAL RANKING:)                               ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════════════════════╗
║                    🎯 РЕКОМЕНДАЦІЇ                                        ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  💡 Рекомендована кількість моделей в раді: 3-6                          ║
║                                                                           ║
║  💡 Занадто мало моделей (< 3):                                          ║
║     - Недостатньо різноманіття думок                                     ║
║     - Агреговані рейтинги менш точні                                     ║
║                                                                           ║
║  💡 Занадто багато моделей (> 6):                                        ║
║     - Значно збільшується час відповіді                                  ║
║     - Зростають витрати на API                                           ║
║     - Складніший аналіз результатів                                      ║
║                                                                           ║
║  💡 Використовуйте моделі від різних провайдерів                         ║
║     для максимального різноманіття                                       ║
║                                                                           ║
║  💡 Chairman може бути тією ж моделлю, що й член ради                    ║
║     або окремою моделлю                                                  ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 📊 Популярні моделі для додавання

| Модель | OpenRouter ID | Провайдер | Особливості |
|--------|---------------|-----------|-------------|
| GPT-4o | `openai/gpt-4o` | OpenAI | 🚀 Швидка, мультимодальна |
| GPT-4o Mini | `openai/gpt-4o-mini` | OpenAI | 💰 Економна |
| Claude 3.5 Sonnet | `anthropic/claude-3.5-sonnet` | Anthropic | 📝 Відмінне письмо |
| Claude 3 Opus | `anthropic/claude-3-opus` | Anthropic | 🧠 Найрозумніша |
| Gemini 1.5 Pro | `google/gemini-pro-1.5` | Google | 📚 Великий контекст |
| Gemini 1.5 Flash | `google/gemini-flash-1.5` | Google | ⚡ Надшвидка |
| Llama 3.1 70B | `meta-llama/llama-3.1-70b-instruct` | Meta | 🆓 Open source |
| Llama 3.1 405B | `meta-llama/llama-3.1-405b-instruct` | Meta | 🏆 Найбільша відкрита |
| Mixtral 8x22B | `mistralai/mixtral-8x22b-instruct` | Mistral | ⚡ MoE архітектура |
| Command R+ | `cohere/command-r-plus` | Cohere | 🔍 RAG оптимізована |

### 🔄 Зміна Chairman моделі

```python
# Варіант 1: Chairman з ради
CHAIRMAN_MODEL = "google/gemini-3-pro-preview"  # Член ради

# Варіант 2: Окремий Chairman
CHAIRMAN_MODEL = "anthropic/claude-3-opus"  # Найрозумніша модель для синтезу

# Варіант 3: Швидкий Chairman
CHAIRMAN_MODEL = "google/gemini-flash-1.5"  # Для швидших відповідей
```

---

## 🔌 Інтеграція з OpenRouter API

### 📡 Структура API запиту

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        📤 API ЗАПИТ                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  POST https://openrouter.ai/api/v1/chat/completions                    │
│                                                                         │
│  Headers:                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Authorization: Bearer sk-or-v1-xxxxx...                        │   │
│  │  Content-Type: application/json                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Body:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  {                                                               │   │
│  │    "model": "openai/gpt-5.1",                                   │   │
│  │    "messages": [                                                │   │
│  │      {                                                          │   │
│  │        "role": "user",                                          │   │
│  │        "content": "Яка столиця України?"                        │   │
│  │      }                                                          │   │
│  │    ]                                                            │   │
│  │  }                                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 📥 Структура API відповіді

```json
{
  "id": "gen-xxxxx",
  "choices": [
    {
      "message": {
        "role": "assistant",
        "content": "Столиця України — місто Київ..."
      }
    }
  ],
  "model": "openai/gpt-5.1",
  "usage": {
    "prompt_tokens": 15,
    "completion_tokens": 150,
    "total_tokens": 165
  }
}
```

### 🔧 Код API клієнта

```python
# 📁 backend/openrouter.py

async def query_model(
    model: str,
    messages: List[Dict[str, str]],
    timeout: float = 120.0  # ⏱️ Timeout 2 хвилини
) -> Optional[Dict[str, Any]]:
    """
    Запит до однієї моделі через OpenRouter API.
    
    Args:
        model: Ідентифікатор моделі (напр. "openai/gpt-4o")
        messages: Список повідомлень [{role, content}]
        timeout: Максимальний час очікування
    
    Returns:
        Словник з 'content' або None при помилці
    """
    
async def query_models_parallel(
    models: List[str],
    messages: List[Dict[str, str]]
) -> Dict[str, Optional[Dict[str, Any]]]:
    """
    Паралельні запити до декількох моделей.
    
    Використовує asyncio.gather() для одночасних запитів.
    """
```

### 🛡️ Обробка помилок

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     🛡️ GRACEFUL DEGRADATION                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ❌ Якщо модель не відповідає → Пропускаємо, продовжуємо з іншими      │
│                                                                         │
│  ❌ Якщо всі моделі Stage 1 не відповіли → Повертаємо помилку          │
│                                                                         │
│  ❌ Якщо Chairman не відповів → Fallback повідомлення про помилку      │
│                                                                         │
│  ✅ Система НІКОЛИ не падає через одну невдалу модель                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 Система рейтингування

### 🧮 Алгоритм агрегації рейтингів

```python
def calculate_aggregate_rankings(
    stage2_results: List[Dict[str, Any]],
    label_to_model: Dict[str, str]
) -> List[Dict[str, Any]]:
    """
    Розраховує агреговані рейтинги по всіх моделях.
    
    Алгоритм:
    1. Для кожної моделі збираємо всі позиції в рейтингах
    2. Обчислюємо середню позицію
    3. Сортуємо від найкращої (найменша позиція) до найгіршої
    """
```

### 📈 Приклад розрахунку

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                    📊 ПРИКЛАД АГРЕГАЦІЇ РЕЙТИНГІВ                         ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  Вхідні рейтинги від 4 моделей (кожна оцінює решту):                     ║
║                                                                           ║
║  ┌────────────┬─────────────────────────────────────────────────────┐    ║
║  │   Суддя    │         Рейтинг (від кращого до гіршого)           │    ║
║  ├────────────┼─────────────────────────────────────────────────────┤    ║
║  │   GPT      │    1. Claude  →  2. Gemini  →  3. Grok             │    ║
║  │   Gemini   │    1. Claude  →  2. GPT     →  3. Grok             │    ║
║  │   Claude   │    1. GPT     →  2. Gemini  →  3. Grok             │    ║
║  │   Grok     │    1. Claude  →  2. GPT     →  3. Gemini           │    ║
║  └────────────┴─────────────────────────────────────────────────────┘    ║
║                                                                           ║
║  Розрахунок середніх позицій (модель не оцінює сама себе):               ║
║                                                                           ║
║  ┌────────────┬───────────────────────────────┬────────────────────────┐ ║
║  │   Модель   │        Позиції (від інших)   │   Середня позиція     │ ║
║  ├────────────┼───────────────────────────────┼────────────────────────┤ ║
║  │   Claude   │   1 (GPT) + 1 (Gem) + 1 (Grok)│  3 / 3 = 1.00 🥇     │ ║
║  │   GPT      │   2 (Gem) + 1 (Cl) + 2 (Grok) │  5 / 3 = 1.67 🥈     │ ║
║  │   Gemini   │   2 (GPT) + 2 (Cl) + 3 (Grok) │  7 / 3 = 2.33 🥉     │ ║
║  │   Grok     │   3 (GPT) + 3 (Gem) + 3 (Cl)  │  9 / 3 = 3.00        │ ║
║  └────────────┴───────────────────────────────┴────────────────────────┘ ║
║                                                                           ║
║  Фінальний агрегований рейтинг:                                          ║
║                                                                           ║
║    🥇 1. Claude  (avg: 1.00) — Всі поставили на 1 місце!                 ║
║    🥈 2. GPT     (avg: 1.67)                                             ║
║    🥉 3. Gemini  (avg: 2.33)                                             ║
║    4. Grok   (avg: 3.00) — Всі поставили на останнє місце                ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 💾 Зберігання даних

### 📂 Структура файлів

```
data/
└── conversations/
    ├── 550e8400-e29b-41d4-a716-446655440000.json
    ├── 6ba7b810-9dad-11d1-80b4-00c04fd430c8.json
    └── ...
```

### 📄 Формат JSON файлу розмови

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "created_at": "2024-12-01T10:30:00.000000",
  "title": "Столиця України",
  "messages": [
    {
      "role": "user",
      "content": "Яка столиця України?"
    },
    {
      "role": "assistant",
      "stage1": [
        {
          "model": "openai/gpt-5.1",
          "response": "Столиця України — Київ..."
        },
        {
          "model": "google/gemini-3-pro-preview",
          "response": "Київ є столицею України..."
        }
      ],
      "stage2": [
        {
          "model": "openai/gpt-5.1",
          "ranking": "Response A provides...\n\nFINAL RANKING:\n1. Response B\n2. Response A",
          "parsed_ranking": ["Response B", "Response A"]
        }
      ],
      "stage3": {
        "model": "google/gemini-3-pro-preview",
        "response": "Узагальнюючи відповіді ради..."
      }
    }
  ]
}
```

### ⚠️ Важливе зауваження

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     ⚠️ METADATA НЕ ЗБЕРІГАЄТЬСЯ                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Наступні дані НЕ зберігаються у JSON файлах:                          │
│                                                                         │
│  • label_to_model mapping (анонімні мітки → назви моделей)             │
│  • aggregate_rankings (агреговані рейтинги)                            │
│                                                                         │
│  Ці дані повертаються тільки в API response і зберігаються             │
│  у стані frontend для відображення.                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🚀 Поради та рекомендації

### 💰 Оптимізація витрат

| Стратегія | Опис | Економія |
|-----------|------|----------|
| 🎯 Менше моделей | 3 моделі замість 6 | ~50% |
| ⚡ Швидкі моделі | Gemini Flash, GPT-4o-mini | ~70% |
| 📏 Короткі промпти | Оптимізувати ranking_prompt | ~20% |
| 🔄 Кешування | (Не реалізовано, можна додати) | ~30% |

### ⏱️ Оптимізація швидкості

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ⏱️ ТИПОВИЙ ЧАС ВИКОНАННЯ                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Stage 1 (паралельно):     ~10-30 секунд                               │
│  Stage 2 (паралельно):     ~15-45 секунд                               │
│  Stage 3 (один запит):     ~5-15 секунд                                │
│  ─────────────────────────────────────────                             │
│  ЗАГАЛОМ:                  ~30-90 секунд                               │
│                                                                         │
│  💡 Для прискорення використовуйте streaming endpoint:                  │
│     POST /api/conversations/{id}/message/stream                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 🐛 Типові проблеми та рішення

| Проблема | Причина | Рішення |
|----------|---------|---------|
| ❌ "All models failed" | Невірний API ключ | Перевірте `.env` файл |
| ❌ Timeout errors | Повільна модель | Збільшіть timeout або замініть модель |
| ❌ Parsing errors | Модель не дотримується формату | Покращте промпт або замініть модель |
| ❌ CORS errors | Неправильний origin | Додайте origin до `main.py` |

### 🧪 Тестування нової моделі

```bash
# 1. Створіть тестовий скрипт
cat > test_model.py << 'EOF'
import asyncio
from backend.openrouter import query_model

async def test():
    response = await query_model(
        "meta-llama/llama-3.1-70b-instruct",
        [{"role": "user", "content": "Hello, test!"}]
    )
    print(response)

asyncio.run(test())
EOF

# 2. Запустіть тест
uv run python test_model.py
```

---

## 📚 Корисні посилання

| Ресурс | URL |
|--------|-----|
| 🌐 OpenRouter | https://openrouter.ai |
| 📋 Список моделей | https://openrouter.ai/models |
| 📖 OpenRouter Docs | https://openrouter.ai/docs |
| 💻 GitHub репозиторій | https://github.com/dogmator/llm-council |

---

## 📝 Швидкий довідник

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                         📝 ШВИДКИЙ ДОВІДНИК                               ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  🔧 Додати модель до ради:                                               ║
║     → Відредагуйте COUNCIL_MODELS у backend/config.py                    ║
║                                                                           ║
║  🎖️ Змінити Chairman:                                                    ║
║     → Відредагуйте CHAIRMAN_MODEL у backend/config.py                    ║
║                                                                           ║
║  🔐 Налаштувати API ключ:                                                ║
║     → Створіть .env файл з OPENROUTER_API_KEY=sk-or-v1-...              ║
║                                                                           ║
║  🚀 Запустити проєкт:                                                    ║
║     → ./start.sh або:                                                    ║
║       Terminal 1: uv run python -m backend.main                          ║
║       Terminal 2: cd frontend && npm run dev                             ║
║                                                                           ║
║  🌐 Відкрити UI:                                                         ║
║     → http://localhost:5173                                              ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```
![map](mind-map.png)
---

<div align="center">

**🏛️ LLM Council — Колективний розум для кращих відповідей**

*Створено з ❤️ для спільноти*

</div>
